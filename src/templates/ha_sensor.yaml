# Template für Home Assistant Sensor Entity (ohne UI-Button)
# Spezielles Template für reine Sensoren, die nur Text-Werte liefern
# ohne zugehörigen LVGL-Button auf der Switches-Seite
#
# Variablen: num, entity_id
# Liefert: State-Text, Domain, Friendly Name, Unit of Measurement

defaults:
  num: "8"
  entity_id: "sensor.placeholder"

text_sensor:
  # Unit of Measurement (Einheit aus Home Assistant)
  - platform: homeassistant
    id: ha_entity_${num}_unit
    entity_id: ${entity_id}
    attribute: unit_of_measurement
    internal: true
    on_value:
      then:
        - lambda: |-
            ESP_LOGD("ha_sensor", "Sensor ${num} unit: %s", x.c_str());

  # State Text (Sensor-Wert als String)
  - platform: homeassistant
    id: ha_entity_${num}_state_text
    entity_id: ${entity_id}
    internal: true
    on_value:
      then:
        - lambda: |-
            ESP_LOGD("ha_sensor", "Sensor ${num} state: %s", x.c_str());
        # LVGL Label aktualisieren wenn vorhanden
        - lvgl.label.update:
            id: ha_temp_value_${num}
            text: !lambda |-
              std::string value = id(ha_entity_${num}_state_text).state;
              std::string unit = id(ha_entity_${num}_unit).state;
              if (value.empty()) {
                // Fallback mit Einheit oder Standardwert
                if (unit.empty()) return std::string("--");
                return std::string("-- ") + unit;
              }
              // Wert mit dynamischer Einheit zurückgeben
              if (unit.empty()) return value;
              return value + "" + unit;

  # Friendly Name
  - platform: homeassistant
    id: ha_entity_${num}_friendly_name
    entity_id: ${entity_id}
    attribute: friendly_name
    internal: true
    on_value:
      then:
        - lvgl.label.update:
            id: ha_sensor_label_${num}
            text: !lambda return x.c_str();

  # Domain (extrahiert aus entity_id)
  - platform: template
    id: ha_entity_${num}_domain
    internal: true
    lambda: |-
      std::string entity_id = "${entity_id}";
      size_t pos = entity_id.find('.');
      if (pos != std::string::npos) {
        return entity_id.substr(0, pos);
      }
      return std::string("unknown");

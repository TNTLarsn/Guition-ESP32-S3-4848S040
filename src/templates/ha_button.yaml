# Template für Home Assistant LVGL Button Widget
# Variablen: num, col, row, default_icon (optional, MDI-Format z.B. "mdi:lightbulb")
# Die Entity-ID wird dynamisch aus dem Text-Sensor ha_entity_${num}_id gelesen

defaults:
  num: "1"
  col: "0"
  row: "0"
  default_icon: "mdi:lightbulb"

button:
  id: homeassistant_btn_${num}
  checkable: true
  grid_cell_column_pos: ${col}
  grid_cell_row_pos: ${row}
  grid_cell_x_align: STRETCH
  grid_cell_y_align: STRETCH
  widgets:
    - label:
        id: homeassistant_btn_${num}_icon
        text_font: btn_icons_font
        text: !lambda return id(ha_entity_${num}_icon)->state;
        align: CENTER
        y: -10
    - label:
        id: homeassistant_btn_${num}_label
        text: "${num}"
        long_mode: dot
        align: CENTER
        y: 30
  on_click:
    # Domains mit nativer .toggle-Unterstützung behandeln
    - if:
        condition:
          lambda: |-
            std::string domain = id(ha_entity_${num}_domain).state;
            // Domains that support .toggle service
            const char* toggle_domains[] = {"switch", "light", "fan", "cover", "valve", "input_boolean", "automation", "script", "remote"};
            for (const char* d : toggle_domains) {
              if (domain == d) return true;
            }
            return false;
        then:
          - homeassistant.service:
              service: !lambda |-
                return std::string(id(ha_entity_${num}_domain).state) + ".toggle";
              data:
                entity_id: !lambda return id(ha_entity_${num}_id).state.c_str();
    # Button-Domain nutzt button.press statt toggle
    - if:
        condition:
          lambda: 'return id(ha_entity_${num}_domain).state == "button";'
        then:
          - homeassistant.service:
              service: button.press
              data:
                entity_id: !lambda return id(ha_entity_${num}_id).state.c_str();
    # Lock-Domain: lock/unlock abhängig vom aktuellen Zustand
    - if:
        condition:
          lambda: 'return id(ha_entity_${num}_domain).state == "lock";'
        then:
          - if:
              condition:
                lambda: 'return id(ha_entity_${num}_state_text).state == "locked";'
              then:
                - homeassistant.service:
                    service: lock.unlock
                    data:
                      entity_id: !lambda return id(ha_entity_${num}_id).state.c_str();
              else:
                - if:
                    condition:
                      lambda: 'return id(ha_entity_${num}_state_text).state == "unlocked";'
                    then:
                      - homeassistant.service:
                          service: lock.lock
                          data:
                            entity_id: !lambda return id(ha_entity_${num}_id).state.c_str();
